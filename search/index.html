<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="utf-8"/><meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>Rastreo de Paquetes | BLR</title>
<meta name="color-scheme" content="light dark"/>
<style>
  body{margin:0;background:#0d1117;color:#e6edf3;font:16px/1.5 system-ui,Segoe UI,Inter}
  .wrap{max-width:980px;margin:auto;padding:24px}
  .panel{background:#0f131a;border:1px solid #232734;border-radius:18px;padding:16px}
  .title{font-size:28px;font-weight:800;margin:0}
  .search{display:grid;grid-template-columns:1fr auto;gap:10px;margin-top:16px}
  input{padding:14px;border-radius:12px;border:1px solid #232734;background:#0b0f16;color:#e6edf3}
  .btn{cursor:pointer;border:1px solid #2d3a7b;background:linear-gradient(180deg,#2b47e5,#2038d0);color:#fff;border-radius:12px;padding:14px 18px;font-weight:700}
  table{width:100%;border-collapse:collapse} th,td{padding:12px;border-bottom:1px dashed #232734;text-align:left}
  .muted{color:#9aa4ae}.empty{border:1px dashed #232734;border-radius:14px;padding:16px;text-align:center;color:#9aa4ae}
</style>
</head>
<body>
<div class="wrap">
  <section class="panel">
    <h1 class="title">Rastrea tus paquetes</h1>
    <div class="search">
      <input id="code" placeholder="Ej: BLR-ABC123"/>
      <button class="btn" id="btnConsultar" onclick="consultar()">Consultar</button>
    </div>
  </section>

  <section id="result" style="display:none;margin-top:14px">
    <div class="panel"><b>Libras pendientes:</b> <span id="lbsP">0.00</span> &nbsp;&nbsp;|&nbsp;&nbsp; <b>Libras enviadas:</b> <span id="lbsE">0.00</span></div>
    <div class="panel" style="margin-top:14px"><h3>Pendientes</h3><div id="pend"></div></div>
    <div class="panel" style="margin-top:14px"><h3>Enviados</h3><div id="env"></div></div>
  </section>

  <section id="empty" style="display:none;margin-top:14px">
    <div class="panel empty">Ingresa tu código para ver tus paquetes.</div>
  </section>
</div>

<script>
const WEBAPP_URL = 'https://script.google.com/macros/s/DEPLOY_ID/exec'; // <-- tu /exec
const $ = s => document.querySelector(s);
const fmtDate = s => { if(!s) return ''; const d=new Date(s); return isNaN(d)?s:d.toLocaleString(); };
const table = items => (!items||!items.length)
  ? `<div class="empty">Sin registros</div>`
  : `<div style="overflow:auto"><table><thead><tr><th>Paquete</th><th>Peso</th><th>Estado</th><th>Actualizado</th></tr></thead><tbody>${
      items.map(p=>`<tr><td>${p.pkg_code}</td><td>${(p.peso_lb??0).toFixed? p.peso_lb.toFixed(2):p.peso_lb}</td><td>${p.estado}</td><td class="muted">${fmtDate(p.fecha_estado||p.fecha)}</td></tr>`).join('')
    }</tbody></table></div>`;

function jsonp(url, ok, fail){
  const cb='blr_cb_'+Math.random().toString(36).slice(2);
  let fired=false;
  window[cb]=d=>{ fired=true; try{ ok(d); } finally{ cleanup(); } };
  function cleanup(){ delete window[cb]; if(s && s.parentNode) s.parentNode.removeChild(s); }
  const s=document.createElement('script');
  s.src = url + (url.includes('?')?'&':'?') + 'callback=' + cb;
  s.async = true;
  s.onerror = () => { cleanup(); fail && fail(new Error('network_error')); };
  s.onload  = () => { setTimeout(()=>{ if(!fired){ fail && fail(new Error('no_callback_executed')); cleanup(); } },0); };
  document.body.appendChild(s);
}

function show(id,on){ document.querySelector(id).style.display = on? 'block':'none'; }

function render(j, code){
  if(!j||!j.ok){
    $('#pend').innerHTML = `<div class='empty'>No se encontraron registros para <b>${code}</b></div>`;
    $('#env').innerHTML  = '';
    $('#lbsP').textContent = '0.00'; $('#lbsE').textContent = '0.00';
    show('#empty',false); show('#result',true); return;
  }
  localStorage.setItem('blr_code', code);
  $('#lbsP').textContent = Number(j.lbs_pendientes||0).toFixed(2);
  $('#lbsE').textContent = Number(j.lbs_enviadas||0).toFixed(2);
  $('#pend').innerHTML = table(j.pendientes||[]);
  $('#env').innerHTML  = table(j.enviados||[]);
  show('#empty',false); show('#result',true);
}

function consultar(){
  const code = $('#code').value.trim();
  if(!code){ show('#result',false); show('#empty',true); return; }
  const btn=$('#btnConsultar'), old=btn.textContent; btn.textContent='Consultando…'; btn.disabled=true;
  const url = `${WEBAPP_URL}?path=api/track&code=${encodeURIComponent(code)}`;
  jsonp(url, d=>{ render(d,code); btn.textContent=old; btn.disabled=false; },
            err=>{ console.error(err); alert('Error consultando el servicio.'); btn.textContent=old; btn.disabled=false; });
}

function getQ(n){ return new URLSearchParams(location.search).get(n); }
document.addEventListener('DOMContentLoaded', ()=>{
  const q = getQ('code') || localStorage.getItem('blr_code');
  if(q){ $('#code').value = q; consultar(); } else { show('#empty',true); }
  $('#code').addEventListener('keydown', e=>{ if(e.key==='Enter') consultar(); });
});
</script>
</body>
</html>
