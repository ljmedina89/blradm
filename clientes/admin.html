<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="utf-8"/><meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>BLR Admin (Online)</title>
<style>
  body{font-family:system-ui,Arial;margin:0;background:#0d1117;color:#e6edf3}
  .wrap{max-width:960px;margin:auto;padding:20px}
  .bar{display:flex;gap:10px;flex-wrap:wrap;margin-bottom:14px}
  .btn{cursor:pointer;border:1px solid #2d3a7b;background:linear-gradient(180deg,#2b47e5,#2038d0);color:#fff;padding:10px 14px;border-radius:10px;font-weight:700}
  .btn.secondary{background:#0f172a;border-color:#2b2f3a}
  .panel{background:#0f131a;border:1px solid #262a36;border-radius:14px;padding:16px;margin:12px 0}
  .row{display:grid;grid-template-columns:1fr 1fr;gap:12px}
  input,select,textarea{padding:10px;border-radius:10px;border:1px solid #2a2f3d;background:#0b0f16;color:#e6edf3;width:100%}
  label{font-size:12px;color:#9aa4ae}
  table{width:100%;border-collapse:collapse}
  th,td{padding:10px;border-bottom:1px dashed #242838;text-align:left}
  .muted{color:#9aa4ae}
</style>
</head>
<body>
<div class="wrap">
  <h2>BLR Admin (100% Online)</h2>
  <div class="bar">
    <button class="btn" onclick="show('formCliente')">+ Nuevo cliente</button>
    <button class="btn" onclick="show('formPaquete')">+ Registrar paquete</button>
    <button class="btn secondary" onclick="cargarClientes()">Actualizar clientes</button>
  </div>

  <div id="formCliente" class="panel">
    <h3>Nuevo cliente</h3>
    <div class="row">
      <div><label>Nombre</label><input id="cNombre" placeholder="Nombre completo"></div>
      <div><label>Teléfono</label><input id="cTel" placeholder="+1 ..."></div>
      <div><label>Email</label><input id="cEmail" placeholder="correo@ejemplo.com"></div>
      <div><label>Dirección</label><input id="cDir" placeholder="Calle, ciudad"></div>
    </div>
    <p><button class="btn" onclick="crearCliente()">Crear</button> <span id="cOut" class="muted"></span></p>
  </div>

  <div id="formPaquete" class="panel">
    <h3>Registrar paquete recibido</h3>
    <div class="row">
      <div><label>Cliente</label><select id="selCliente"></select></div>
      <div><label>Peso (lb)</label><input id="pPeso" type="number" step="0.01" min="0.01" placeholder="1.85"></div>
    </div>
    <div style="margin-top:8px"><label>Nota (opcional)</label><textarea id="pNota" rows="2" placeholder="Amazon #123-456..."></textarea></div>
    <p><button class="btn" onclick="registrarPaquete()">Guardar paquete</button> <span id="pOut" class="muted"></span></p>
  </div>

  <div class="panel">
    <h3>Últimos paquetes</h3>
    <div style="display:flex;gap:8px;align-items:center;margin-bottom:8px">
      <label>Filtrar</label>
      <select id="fEstado" onchange="cargarPaquetes()">
        <option value="">Todos</option><option>Recibido</option><option>Consolidado</option><option>Enviado</option>
      </select>
      <button class="btn secondary" onclick="cargarPaquetes()">Actualizar</button>
    </div>
    <div id="tabla"></div>
  </div>
</div>

<script>
const API_URL = 'https://script.google.com/macros/s/AKfycbxfeIXBDJp7XNbDPy1U_r27JCWbW0vgCK3tDBzDWlmi9Ogd0xw7wffvPkPM3q8Xy8k8Ew/exec';
const $ = s => document.querySelector(s);
const toQS = o => new URLSearchParams(o).toString();
function show(id){ /* visibles siempre */ }

async function apiGet(path, params={}){
  params._ts = Date.now();
  const url = `${API_URL}?${toQS({ path, ...params })}`;
  const r = await fetch(url, { method:'GET', headers:{ 'Accept':'application/json' }, cache:'no-store' });
  try { return await r.json(); } catch { return { ok:false, error:'bad_json' }; }
}
async function apiPost(path, body={}){
  const r = await fetch(API_URL, { method:'POST', headers:{ 'Content-Type':'application/x-www-form-urlencoded' }, body: toQS({ path, ...body }) });
  try { return await r.json(); } catch { return { ok:false, error:'bad_json' }; }
}

async function cargarClientes(){
  const res = await apiGet('api/clients');
  const sel = $('#selCliente');
  sel.innerHTML = (res.ok && res.clients?.length)
    ? res.clients.map(c => `<option value="${c.cliente_code}">${c.cliente_code} — ${c.nombre}</option>`).join('')
    : '<option value="">(Sin clientes)</option>';
}
async function crearCliente(){
  const nombre = $('#cNombre').value.trim(), telefono = $('#cTel').value.trim(), email = $('#cEmail').value.trim(), direccion = $('#cDir').value.trim();
  if(!nombre) return alert('Nombre requerido');
  const res = await apiPost('api/clients/create', { nombre, telefono, email, direccion });
  if(res.ok){
    $('#cOut').textContent = 'Creado: '+res.cliente_code;
    $('#cNombre').value = $('#cTel').value = $('#cEmail').value = $('#cDir').value = '';
    await cargarClientes(); $('#selCliente').value = res.cliente_code;
  } else $('#cOut').textContent = 'Error: '+(res.error||'');
}

async function registrarPaquete(){
  const cliente_code = $('#selCliente').value;
  const peso_lb = parseFloat($('#pPeso').value);
  const nota = $('#pNota').value.trim();
  if(!cliente_code) return alert('Selecciona cliente');
  if(isNaN(peso_lb) || peso_lb<=0) return alert('Peso inválido');
  const res = await apiPost('api/packages/create', { cliente_code, peso_lb, nota });
  $('#pOut').textContent = res.ok ? ('Guardado: '+res.pkg_code) : ('Error: '+(res.error||''));
  if(res.ok){ $('#pPeso').value=''; $('#pNota').value=''; cargarPaquetes(); }
}

function estadoSelect(actual){ const opts=['Recibido','Consolidado','Enviado']; return `<select class="estadoSel">${opts.map(o=>`<option ${o===actual?'selected':''}>${o}</option>`).join('')}</select>`; }
async function cargarPaquetes(){
  const estado = $('#fEstado').value || '';
  const res = await apiGet('api/packages', { estado, limit: 50 });
  const items = res.ok ? (res.packages || []) : [];
  const rows = items.map(r=>`
    <tr data-pkg="${r.pkg_code}">
      <td>${r.pkg_code}</td><td class="muted">${r.cliente_code}</td><td>${(r.peso_lb??0).toFixed? r.peso_lb.toFixed(2):r.peso_lb}</td>
      <td>${estadoSelect(r.estado)}</td><td class="muted">${r.fecha_estado || r.fecha || ''}</td>
      <td><input class="cidInput" placeholder="consolidation_id (opcional)" style="width:170px"/> <button class="btn secondary" onclick="guardarEstado(this)">Guardar</button></td>
    </tr>`).join('');
  document.getElementById('tabla').innerHTML = `<div style="overflow:auto"><table><thead><tr><th>PKG</th><th>Cliente</th><th>Peso</th><th>Estado</th><th>Actualizado</th><th>Acción</th></tr></thead><tbody>${rows || '<tr><td colspan="6" class="muted">Sin registros</td></tr>'}</tbody></table></div>`;
}
async function guardarEstado(btn){
  const tr = btn.closest('tr'); const pkg_code = tr.dataset.pkg;
  const estado = tr.querySelector('.estadoSel').value;
  const consolidation_id = tr.querySelector('.cidInput').value.trim();
  const res = await apiPost('api/packages/updateStatus', { pkg_code, estado, consolidation_id });
  if(res.ok){ btn.textContent='✔'; setTimeout(()=>btn.textContent='Guardar',800); cargarPaquetes(); }
  else alert('Error: '+(res.error||''));
}

document.addEventListener('DOMContentLoaded', async ()=>{ await cargarClientes(); await cargarPaquetes(); });
</script>
</body>
</html>
